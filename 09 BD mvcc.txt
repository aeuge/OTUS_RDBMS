-- развернем ВМ postgres в GCE
gcloud beta compute --project=calm-tendril-290110 instances CREATE postgres --zone=us-central1-a --machine-type=e2-medium --subnet=default --network-tier=PREMIUM --maintenance-policy=MIGRATE --service-account=322426944095-compute@developer.gserviceaccount.com --scopes=https://www.googleapis.com/auth/devstorage.read_only,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/servicecontrol,https://www.googleapis.com/auth/service.management.readonly,https://www.googleapis.com/auth/trace.append --image=ubuntu-2004-focal-v20200907 --image-project=ubuntu-os-cloud --boot-disk-size=10GB --boot-disk-type=pd-ssd --boot-disk-device-name=postgres --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=any
 
gcloud compute ssh postgres
 
-- установим 13 версию
-- https://www.postgresql.org/download/linux/ubuntu/

sudo apt UPDATE && sudo apt upgrade -y && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get UPDATE && sudo apt-get -y install postgresql && sudo apt install unzip

-- посмотрим, что кластер стартовал
pg_lsclusters

sudo -u postgres psql
-- sudo su postgres
-- psql


SELECT txid_current();
CREATE TABLE test(i int);
INSERT INTO test VALUES (10),(20),(30);

\echo :AUTOCOMMIT
\set AUTOCOMMIT OFF
show transaction isolation level;
-- set transaction isolation level read committed;
SELECT txid_current();

SELECT relname, n_live_tup, n_dead_tup, trunc(100*n_dead_tup/(n_live_tup+1))::float "ratio%", last_autovacuum FROM pg_stat_user_TABLEs WHERE relname = 'test';

UPDATE test set i = 4 WHERE i = 3;

-- посмотрим что теперь
SELECT relname, n_live_tup, n_dead_tup, trunc(100*n_dead_tup/(n_live_tup+1))::float "ratio%", last_autovacuum FROM pg_stat_user_TABLEs WHERE relname = 'test';


SELECT xmin,xmax,cmin,cmax,ctid FROM test;
CREATE EXTENSION pageinspect;
\dx+
SELECT lp as tuple, t_xmin, t_xmax, t_field3 as t_cid, t_ctid FROM heap_page_items(get_raw_page('test',0));
SELECT * FROM heap_page_items(get_raw_page('test',0)) \gx

-- попробуем изменить данные и откатить транзакцию и посмотреть
https://postgrespro.ru/docs/postgrespro/12/pageinspect


--вакуум
сценарий -
 в 1 окне пообновляем запись
 в 2 окне делаем set transaction isolation level repeaTABLE read;
 в 1 пообновляем еще и потом смотрим vacuum verbose
vacuum verbose test

SELECT lp as tuple, t_xmin, t_xmax, t_field3 as t_cid, t_ctid FROM heap_page_items(get_raw_page('test',0));

vacuum full test
 в 1 окне пообновляем запись без коммита
 в 2 попробуем full

-- автовакуум
SELECT name, setting, context, short_desc FROM pg_settings WHERE category like '%Autovacuum%';

-- попробуем поймать автовакуум
-- запустим бенч https://postgrespro.ru/docs/postgresql/12/pgbench
pgbench -i
pgbench -T 10

SELECT relname, n_live_tup, n_dead_tup, trunc(100*n_dead_tup/(n_live_tup+1))::float "ratio%", last_autovacuum FROM pg_stat_user_TABLEs WHERE relname like 'pgbench%';

SELECT * FROM pg_stat_activity WHERE query ~ 'autovacuum' \gx



-- уровни изоляции транзакций
-- создадим табличку для тестов
CREATE DATABASE backup;
\c backup
-- список БД
\l
SELECT current_database();
CREATE TABLE test (i serial, amount int);
INSERT INTO test(amount) VALUES (100);
INSERT INTO test(amount) VALUES (500);
SELECT * FROM test;

\echo :AUTOCOMMIT
\set AUTOCOMMIT OFF
show transaction isolation level;
set transaction isolation level read committed;
set transaction isolation level repeaTABLE read;
set transaction isolation level serializable;
SELECT txid_current();

SELECT txid_current_snapshot();
SELECT * FROM pg_stat_activity;

-- test TRANSACTION ISOLATION LEVEL READ COMMITTED;
-- 1 console
begin;
SELECT * FROM testA;

-- 2 consoleapp=# 
begin;
UPDATE testA set amount = 555 WHERE i = 1;
commit;

-- 1 console
SELECT * FROM testA; -- different values



-- TRANSACTION ISOLATION LEVEL REPEATABLE READ;
-- 1 console
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
BEGIN;
-- WARNING:  there is already a transaction in progress
SELECT * FROM testA;
 i | amount
---+--------
 2 |    500
 1 |    555
(2 rows)

-- 2 console
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
INSERT INTO testA VALUES (777);
COMMIT;

-- 1 console
SELECT * FROM testA;
 i | amount
---+--------
 2 |    500
 1 |    555
(2 rows)



-- TRANSACTION ISOLATION LEVEL SERIALIZABLE;
DROP TABLE IF EXISTS testS;
CREATE TABLE testS (i int, amount int);
INSERT INTO TESTS VALUES (1,10), (1,20), (2,100), (2,200); 
COMMIT;

-- 1 console
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
SELECT sum(amount) FROM testS WHERE i = 1;
INSERT INTO testS VALUES (2,30);

-- 2 consol
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
SELECT sum(amount) FROM testS WHERE i = 2;
INSERT INTO testS VALUES (1,200);

-- 1 console 
COMMIT;

-- 2 console 
COMMIT;


-- удалим наш проект
gcloud compute instances delete postgres
